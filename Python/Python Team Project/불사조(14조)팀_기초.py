# -*- coding: utf-8 -*-
"""e-commerce Project_ì½”ë“œ ì·¨í•©.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1EajiDDVKn1kOnzlqmIyCPV8hXpnscO9n
"""

!pip install koreanize-matplotlib #í•œê¸€í°íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
!apt-get install -y fonts-nanum #ë‚˜ëˆ” ê³ ë”• í°íŠ¸ ì„¤ì¹˜
!pip install -q gdown

import gdown
import matplotlib.pyplot as plt
import koreanize_matplotlib  # í•œê¸€ ìë™ ì„¤ì •ë¨
import pandas as pd
import seaborn as sns

from google.colab import drive
drive.mount('/content/drive')

# plt.rcParams['font.family'] = 'NanumGothic' #ë‚˜ëˆ” ê³ ë”• í°íŠ¸ ì„¤ì •

# CSV íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°

transactions_file_id = '1rzQ8Bz6hGQ7IYZPWzEkaXIJXvA6pCFkq'
output_path = 'transactions_hm.csv'
gdown.download(f'https://drive.google.com/uc?id={transactions_file_id}', output_path, quiet=False)


articles = pd.read_csv('https://drive.google.com/uc?id=1OYMa1QBf6Lt2vVABrFJi8FO4UFhieVRv')
customers = pd.read_csv('https://drive.google.com/uc?id=1uyHiU-iKwJi8ht3TqBqmmFojvSc0CY_N')
transactions = pd.read_csv('transactions_hm.csv')

# ê° í…Œì´ë¸”ì— ëŒ€í•œ ì—´ê³¼ í–‰ ê°œìˆ˜ë¥¼ í‘œí˜„í•´ì£¼ì„¸ìš”.
articles.shape # (105542, 25)
customers.shape # (1048575, 6)
transactions.shape # (1048575, 5)

# ê° í…Œì´ë¸”ì— ëŒ€í•œ ì»¬ëŸ¼íƒ€ì…ê³¼ í†µê³„ëŸ‰ì„ ë³´ì—¬ì£¼ì„¸ìš”.
articles.info()
articles.describe()
customers.info()
customers.describe()
transactions.info()
transactions.describe()

# NULL ê°’ì´ ì¡´ì¬í•˜ëŠ” ê²½ìš°, ëŒ€ì²´ or ì œê±° ëª¨ë‘ ê°€ëŠ¥í•©ë‹ˆë‹¤.
customers.isnull().sum() # fashion_news_frequency (íŒ¨ì…˜ ë‰´ìŠ¤ ì•ŒëŒ ì£¼ê¸°) ì»¬ëŸ¼ null ê°’ 1ê°œ
articles.isnull().sum() # detail_desc (ì œí’ˆ ìƒì„¸ ì„¤ëª…) ì»¬ëŸ¼ null ê°’ 416
transactions.isnull().sum() # null ê°’ 0ê°œ

# NULL ê°’ ì œê±°/ëŒ€ì²´ í•„ìš”ì—†ì–´ ë³´ì„

customers.isnull().sum()

"""# **ê°€ì„¤ : ìƒ‰ìƒ ì „ë¬¸ ê¸°ì—… Pantoneì˜ 2019ë…„ year of color â€˜Living Coralâ€™ ìƒ‰ìƒë³„ ë§¤ì¶œì— ì˜í–¥ì„ ë¯¸ì¹  ê²ƒì´ë‹¤.**"""

# í…Œì´ë¸”ì„ ê²°í•©í•˜ì—¬, ë°ì´í„°ë¶„ì„ì„ ìœ„í•œ í•˜ë‚˜ì˜ ë°ì´í„°ì…‹ìœ¼ë¡œ ë§Œë“¤ì–´ì£¼ì„¸ìš”.
# ëª¨ë“  í…Œì´ë¸”ì„ ê²°í•©í•˜ì§€ ì•Šì•„ë„ ì¢‹ìŠµë‹ˆë‹¤.
# í…Œì´ë¸” ê²°í•© ì‹œ inner join ìœ¼ë¡œ ì§„í–‰í•´ì£¼ì„¸ìš”.
df_total_table = pd.merge(transactions, customers, on='customer_id', how='inner')
df_total_table = pd.merge(df_total_table, articles, on='article_id', how='inner')
df_total_table.head()

df_total_table["t_datetime"] = pd.to_datetime(df_total_table["t_dat"])
df_total_table["month"] = df_total_table["t_datetime"].dt.month

# ì‹¤ì œ ê¸ˆì•¡ì²˜ëŸ¼ ë³´ì´ê²Œ price ì •ê·œí™” í•´ì œ (ì˜ˆ: 100,000 ê³±í•˜ê¸°)
# df_total_table["price_real"] = df_total_table["price"] * 100000

# ì›” ë³„ íŒë§¤ëŸ‰ê³¼ ì£¼ë¬¸ ìˆ˜ëŸ‰ ì§‘ê³„
df_total_table.groupby("month").agg(
    total_sales=("price", "sum"),
    order_count=("price", "count")
).sort_index()

# ì›” ë³„ í†µê³„ëŸ‰
# df_total_table.groupby("month")["price"].agg(["mean", "median", "max", "min", "count"])

import matplotlib.pyplot as plt

# ì›”ë³„ ì§‘ê³„
monthly_summary = df_total_table.groupby("month").agg(
    total_sales=("price", "sum"),
    order_count=("price", "count")
).sort_index()

# í†µê³„ê°’ ê³„ì‚°
mean_sales = monthly_summary['total_sales'].mean()
median_sales = monthly_summary['total_sales'].median()
mean_orders = monthly_summary['order_count'].mean()
median_orders = monthly_summary['order_count'].median()

# ì‹œê°í™” ì‹œì‘
fig, ax1 = plt.subplots(figsize=(12, 6))

# â‘  ì‹¤ì„ : íŒë§¤ ë§¤ì¶œ
ax1.plot(
    monthly_summary.index,
    monthly_summary['total_sales'],
    color='tab:blue',
    marker='o',
    linestyle='-',
    label='Total Sales'
)
ax1.axhline(mean_sales, color='tab:blue', linestyle=':', label='Sales Mean')

# âœ… ë§¤ì¶œ ë°ì´í„° ë¼ë²¨ (ì™¼ìª½ìœ¼ë¡œ ì‚´ì§ ì´ë™)
for x, y in zip(monthly_summary.index, monthly_summary['total_sales']):
    ax1.text(x - 0.15, y, f'{y:,.0f}', color='tab:blue', fontsize=9, ha='right', va='bottom')

ax1.set_xlabel('Month')
ax1.set_ylabel('Total Sales (â‚©)', color='tab:blue')
ax1.tick_params(axis='y', labelcolor='tab:blue')
ax1.set_xticks(monthly_summary.index)

# â‘¡ ì‹¤ì„ : ì£¼ë¬¸ëŸ‰
ax2 = ax1.twinx()
ax2.plot(
    monthly_summary.index,
    monthly_summary['order_count'],
    color='tab:red',
    marker='s',
    linestyle='-',
    label='Order Count'
)
ax2.axhline(mean_orders, color='tab:red', linestyle=':', label='Order Mean')

# âœ… ì£¼ë¬¸ ìˆ˜ ë°ì´í„° ë¼ë²¨ (ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì‚´ì§ ì´ë™)
for x, y in zip(monthly_summary.index, monthly_summary['order_count']):
    ax2.text(x + 0.15, y, f'{int(y)}', color='tab:red', fontsize=9, ha='left', va='bottom')

ax2.set_ylabel('Order Count', color='tab:red')
ax2.tick_params(axis='y', labelcolor='tab:red')

# ì œëª©
plt.title('ì›”ë³„ íŒë§¤ ë§¤ì¶œ & ì£¼ë¬¸ëŸ‰ (í‰ê· ì„ /ì¤‘ì•™ê°’ í¬í•¨ + ì¢Œìš° ë¶„ë¦¬ ë¼ë²¨)', fontsize=14)
fig.tight_layout()

# ë²”ë¡€ ë³‘í•©
lines1, labels1 = ax1.get_legend_handles_labels()
lines2, labels2 = ax2.get_legend_handles_labels()
fig.legend(lines1 + lines2, labels1 + labels2, loc='upper center', ncol=3)

plt.show()

import matplotlib.pyplot as plt

# ìƒ‰ìƒë³„ ì›”ë³„ íŒë§¤ëŸ‰ ì§‘ê³„
color_month_counts = df_total_table.groupby(['month', 'perceived_colour_master_name']).size().reset_index(name='count')

# ì „ì²´ì ìœ¼ë¡œ ê°€ì¥ ë§ì´ íŒ”ë¦° ìƒ‰ìƒ Top 10
top_colors = color_month_counts.groupby('perceived_colour_master_name')['count'].sum().nlargest(10).index

# Top 10 ìƒ‰ìƒë§Œ í•„í„°ë§
filtered = color_month_counts[color_month_counts['perceived_colour_master_name'].isin(top_colors)]

# Pivot: ì›”ì„ indexë¡œ, ìƒ‰ìƒë³„ ì»¬ëŸ¼ìœ¼ë¡œ
pivot_df = filtered.pivot(index='month', columns='perceived_colour_master_name', values='count').fillna(0).sort_index()


# ìƒ‰ìƒ ì´ë¦„ ë§¤í•‘ (matplotlibì´ ì¸ì‹ ê°€ëŠ¥í•œ ì´ë¦„ ë˜ëŠ” HEX)
color_map = {
    'Red': 'red',
    'Blue': 'blue',
    'Green': 'green',
    'Black': 'black',
    'White': 'gray',
    'Yellow': 'yellow',
    'Pink': 'pink',
    'Orange': 'orange',
    'Khaki green': '#7e805d',
    'Beige': '#c8ad7f',
}

# NaN ì²˜ë¦¬
pivot_df = pivot_df.fillna(0)

plt.figure(figsize=(14, 8))

# ì»¬ëŸ¼ëª… ë°˜ë³µ
for color in pivot_df.columns:
    line_color = color_map.get(color, 'gray')  # ë§¤í•‘ ì—†ìœ¼ë©´ íšŒìƒ‰
    try:
        plt.plot(pivot_df.index, pivot_df[color], marker='o', label=color, color=line_color)
    except Exception as e:
        print(f"Error plotting {color}: {e}")

plt.title('Top 10 ìƒ‰ìƒë³„ ì›”ë³„ íŒë§¤ëŸ‰ ì¶”ì´', fontsize=16)
plt.xlabel('ì›”', fontsize=12)
plt.ylabel('íŒë§¤ ê±´ìˆ˜', fontsize=12)
plt.xticks(range(1, 13))
plt.legend(title='ìƒ‰ìƒ', bbox_to_anchor=(1.05, 1), loc='upper left')
plt.grid(True)
plt.tight_layout()
plt.show()

# ê³„ì ˆ ì»¬ëŸ¼ ìƒì„±
df_total_table['season'] = df_total_table['month'].map({
    12: 'ê²¨ìš¸', 1: 'ê²¨ìš¸', 2: 'ê²¨ìš¸',
    3: 'ë´„', 4: 'ë´„', 5: 'ë´„',
    6: 'ì—¬ë¦„', 7: 'ì—¬ë¦„', 8: 'ì—¬ë¦„',
    9: 'ê°€ì„', 10: 'ê°€ì„', 11: 'ê°€ì„'
})

# ìƒ‰ìƒë³„ ê³„ì ˆë³„ íŒë§¤ëŸ‰ ì§‘ê³„
color_season_counts = df_total_table.groupby(['season', 'perceived_colour_master_name']).size().reset_index(name='count')

# Top 10 ìƒ‰ìƒ ê¸°ì¤€ í•„í„°ë§
color_season_counts = color_season_counts[color_season_counts['perceived_colour_master_name'].isin(top_colors)]

# í”¼ë²— í…Œì´ë¸” ìƒì„±
pivot_season = color_season_counts.pivot(index='season', columns='perceived_colour_master_name', values='count').fillna(0)

# ê³„ì ˆ ìˆœì„œ ì§€ì •
season_order = ['ë´„', 'ì—¬ë¦„', 'ê°€ì„', 'ê²¨ìš¸']
pivot_season = pivot_season.loc[season_order]


plt.figure(figsize=(12, 6))

for color in pivot_season.columns:
    line_color = color_map.get(color, 'gray')  # color_mapì—ì„œ ìƒ‰ìƒ ê°€ì ¸ì˜¤ê¸°, ì—†ìœ¼ë©´ íšŒìƒ‰
    plt.plot(pivot_season.index, pivot_season[color], marker='o', label=color, color=line_color)

plt.title('Top 10 ìƒ‰ìƒë³„ ê³„ì ˆë³„ íŒë§¤ëŸ‰ ì¶”ì´', fontsize=16)
plt.xlabel('ê³„ì ˆ', fontsize=12)
plt.ylabel('íŒë§¤ ê±´ìˆ˜', fontsize=12)
plt.legend(title='ìƒ‰ìƒ', bbox_to_anchor=(1.05, 1), loc='upper left')
plt.grid(True)
plt.tight_layout()
plt.show()

import seaborn as sns
import matplotlib.pyplot as plt

# ì¡°í•©ë³„ ì „ì²´ êµ¬ë§¤ ê±´ìˆ˜ ì§‘ê³„
combo_count_total = df_total_table.groupby(
    ['sales_channel_id', 'product_type_name']
).size().reset_index(name='count')

# ì±„ë„ ì´ë¦„ ë§¤í•‘
channel_map = {1: 'ì˜¤í”„ë¼ì¸', 2: 'ì˜¨ë¼ì¸'}

# ìµœëŒ€ ê±´ìˆ˜ êµ¬í•´ì„œ xì¶• í†µì¼
max_count = combo_count_total['count'].max()

# Subplots ì¤€ë¹„
fig, axes = plt.subplots(nrows=1, ncols=2, figsize=(16, 8), sharex=True)

# ê·¸ë˜í”„ ê·¸ë¦¬ê¸°
for i, channel_id in enumerate([1, 2]):
    group = combo_count_total[combo_count_total['sales_channel_id'] == channel_id]
    top_combos = group.sort_values('count', ascending=False).head(10)

    sns.barplot(
        data=top_combos,
        y='product_type_name',
        x='count',
        palette='viridis',
        ax=axes[i]
    )

    axes[i].set_title(f"{channel_map[channel_id]} ì±„ë„", fontsize=14)
    axes[i].set_xlabel('Purchase Count')
    axes[i].set_ylabel('Product Type')
    axes[i].set_xlim(0, max_count * 1.1)  # ë™ì¼í•œ xì¶• ë²”ìœ„

# ì „ì²´ íƒ€ì´í‹€ê³¼ ë ˆì´ì•„ì›ƒ ì¡°ì •
plt.suptitle('Top 10 Product Types by Purchase Count per Channel', fontsize=16)
plt.tight_layout(rect=[0, 0, 1, 0.95])
plt.show()

"""# **ê°€ì„¤ : íŠ¹ì • ê¸°ê°„(ì˜ˆ: ì›”ë³„)ì— ê³ ê° í™œë™ëŸ‰(ê±°ë˜ ê±´ìˆ˜ ë˜ëŠ” ê±°ë˜ ê¸ˆì•¡)ì´ ìœ ì˜ë¯¸í•œ ì°¨ì´ë¥¼ ë³´ì¼ ê²ƒì´ë‹¤.**

## **ê³„ì ˆë³„-ì±„ë„ë³„ íŒë§¤ë˜ëŠ” ìƒí’ˆ ë³´ê¸°**
"""

import pandas as pd
import seaborn as sns
import matplotlib.pyplot as plt

# 1. ê³„ì ˆ, ì±„ë„ ì»¬ëŸ¼ ìƒì„±
df_total_table['month'] = pd.to_datetime(df_total_table['t_dat']).dt.month
season_map = {12: 'ê²¨ìš¸', 1: 'ê²¨ìš¸', 2: 'ê²¨ìš¸',
              3: 'ë´„', 4: 'ë´„', 5: 'ë´„',
              6: 'ì—¬ë¦„', 7: 'ì—¬ë¦„', 8: 'ì—¬ë¦„',
              9: 'ê°€ì„', 10: 'ê°€ì„', 11: 'ê°€ì„'}
df_total_table['season'] = df_total_table['month'].map(season_map)

channel_map = {1: 'ì˜¤í”„ë¼ì¸', 2: 'ì˜¨ë¼ì¸'}
df_total_table['channel'] = df_total_table['sales_channel_id'].map(channel_map)

# 2. ê³„ì ˆ + ì±„ë„ + ìƒí’ˆìœ í˜•ë³„ íŒë§¤ëŸ‰ ì§‘ê³„
season_channel_product_counts = df_total_table.groupby(
    ['season', 'channel', 'product_type_name']
).size().reset_index(name='count')

# 3. ê³„ì ˆë³„, ì±„ë„ë³„ Top 10 ìƒí’ˆ ë½‘ê¸°
top10_season_channel_products = season_channel_product_counts.groupby(['season', 'channel']).apply(
    lambda x: x.nlargest(10, 'count')
).reset_index(drop=True)

# 4. ì „ì²´ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬ ìˆœì„œ ì§€ì •
overall_order = top10_season_channel_products.groupby('product_type_name')['count'].sum().sort_values(ascending=False).index.tolist()

# í˜„ì¬ ë°ì´í„°ì— í¬í•¨ëœ ìƒí’ˆë§Œ ê±¸ëŸ¬ì„œ ìˆœì„œ ë¦¬ìŠ¤íŠ¸ ë§Œë“¤ê¸°
filtered_order = [ptype for ptype in overall_order if ptype in top10_season_channel_products['product_type_name'].unique()]

# 5. ê·¸ë˜í”„ ê·¸ë¦¬ê¸°
g = sns.catplot(
    data=top10_season_channel_products,
    x='count',
    y='product_type_name',
    col='season',
    hue='channel',
    kind='bar',
    col_order=['ë´„', 'ì—¬ë¦„', 'ê°€ì„', 'ê²¨ìš¸'],
    height=5,
    aspect=0.8,
    dodge=True,
    order=filtered_order
)

g.set_titles("{col_name} íŒë§¤ëŸ‰ Top 10")
g.set_axis_labels("íŒë§¤ ê±´ìˆ˜", "ìƒí’ˆ ìœ í˜•")

# yì¶• ê¸€ì ì‘ê²Œ (ìƒí’ˆëª…ì´ ê¸¸ë©´ ìœ ìš©)
for ax in g.axes.flatten():
    ax.tick_params(axis='y', labelsize=8)

plt.tight_layout()
plt.show()

"""# **ê°€ì„¤ : ì—°ë ¹ëŒ€ì— ë”°ë¼ ì´ ë§¤ì¶œ ê·œëª¨ê°€ ë‹¤ë¥¼ ê²ƒì´ë‹¤.**"""

# ì—°ë ¹ëŒ€ ì»¬ëŸ¼ ìƒì„±
def get_age_group(age):
  if age < 20:
    return '10ëŒ€ ì´í•˜'
  elif age < 30:
    return '20ëŒ€'
  elif age < 40:
    return '30ëŒ€'
  elif age < 50:
    return '40ëŒ€'
  elif age < 60:
    return '50ëŒ€'
  else:
    return '60ëŒ€ ì´ìƒ'

customers['age_group'] = customers['age'].apply(get_age_group)

# í…Œì´ë¸”ì„ ê²°í•©í•˜ì—¬, ë°ì´í„°ë¶„ì„ì„ ìœ„í•œ í•˜ë‚˜ì˜ ë°ì´í„°ì…‹ìœ¼ë¡œ ë§Œë“¤ì–´ì£¼ì„¸ìš”.
# ëª¨ë“  í…Œì´ë¸”ì„ ê²°í•©í•˜ì§€ ì•Šì•„ë„ ì¢‹ìŠµë‹ˆë‹¤.
# í…Œì´ë¸” ê²°í•© ì‹œ inner join ìœ¼ë¡œ ì§„í–‰í•´ì£¼ì„¸ìš”.

# ê±°ë˜ ë°ì´í„°ì— ê³ ê° ì •ë³´ ë³‘í•©
merged_df = pd.merge(transactions, customers, on='customer_id', how='inner')

merged_df.head()

# ì—°ë ¹ëŒ€ë³„ ë§¤ì¶œ ì§‘ê³„
sales_by_age = merged_df.groupby('age_group')['price'].sum().reset_index()

sales_by_age

plt.figure(figsize=(8,5))
bars = plt.bar(sales_by_age['age_group'], sales_by_age['price'])

# ë§‰ëŒ€ ê·¸ë˜í”„ ìœ„ì— ë§¤ì¶œ ìˆ«ì í‘œì‹œ
for bar in bars:
    yval = bar.get_height()
    plt.text(bar.get_x() + bar.get_width()/2, yval + 50,  # ìˆ«ìê°€ ë§‰ëŒ€ ìœ„ë¡œ ì¡°ê¸ˆ ì˜¬ë¼ê°€ê²Œ ì¡°ì •
             f'{yval:,.0f}', ha='center', va='bottom')  # ìˆ«ì í˜•ì‹ì„ ì‰¼í‘œë¡œ ì¶”ê°€

plt.title('ì—°ë ¹ëŒ€ ë³„ ë§¤ì¶œ í˜„í™©')
plt.xlabel('ì—°ë ¹ëŒ€')
plt.ylabel('ì´ ë§¤ì¶œ')
plt.show()

'''
ë¶„ì„ ìš”ì•½
1. 20ëŒ€ê°€ ê°€ì¥ í° ë§¤ì¶œ ë¹„ì¤‘ì„ ì°¨ì§€í•˜ê³  ìˆë‹¤.
2. ê·¸ ë‹¤ìŒì€ 30ëŒ€, 50ëŒ€, 40ëŒ€ê°€ ë§ì´ ì°¨ì§€
3. 10ëŒ€ ì´í•˜ëŠ” ë§¤ì¶œ ë¹„ì¤‘ì´ ê°€ì¥ ë‚®ë‹¤

'''

"""# **ê°€ì„¤ : ì—°ë ¹ëŒ€ì— ë”°ë¼ êµ¬ë§¤ ì±„ë„ ì„ í˜¸ë„ê°€ ë‹¤ë¥´ë‹¤**"""

# ì—°ë ¹ëŒ€ ì»¬ëŸ¼ ìƒì„±
def get_age_group(age):
    if age < 20:
        return '10ëŒ€ ì´í•˜'
    elif age < 30:
        return '20ëŒ€'
    elif age < 40:
        return '30ëŒ€'
    elif age < 50:
        return '40ëŒ€'
    elif age < 60:
        return '50ëŒ€'
    else:
        return '60ëŒ€ ì´ìƒ'

customers['age_group'] = customers['age'].apply(get_age_group)

customers.head()

# ê±°ë˜ ë°ì´í„°ì™€ ê³ ê° ë°ì´í„°ë¥¼ customer_id ê¸°ì¤€ìœ¼ë¡œ INNER JOIN
merged = pd.merge(transactions, customers, on='customer_id', how='inner')

# ì „ì²´ ê³ ê° ëŒ€ìƒ ì˜¨ë¼ì¸/ì˜¤í”„ë¼ì¸ êµ¬ë§¤ ë¹„ì¤‘
total_counts = merged['sales_channel_id'].value_counts().sort_index()
total_ratio = total_counts / total_counts.sum() * 100


print("ì „ì²´ ê³ ê° ëŒ€ìƒ ì˜¨ë¼ì¸/ì˜¤í”„ë¼ì¸ êµ¬ë§¤ ë¹„ì¤‘ (%)")
print(total_ratio)
print(total_counts)

# ì˜¨ë¼ì¸ ë¹„ì¤‘ì´ ë” ë†’ë‹¤

# íŒŒì´ ì°¨íŠ¸ë¡œ ë³´ê¸°

ratio = total_ratio
labels = ['ì˜¤í”„ë¼ì¸', 'ì˜¨ë¼ì¸']
explode = [0, 0.01]
wedgeprops={'width': 0.7, 'edgecolor': 'w', 'linewidth': 5}
plt.pie(ratio, labels=labels, autopct='%.1f%%', explode=explode, wedgeprops=wedgeprops)
plt.title('ì±„ë„ë³„ êµ¬ë§¤ ë¹„ìœ¨')
plt.show()

# ì—°ë ¹ëŒ€ë³„ ì˜¨ë¼ì¸/ì˜¤í”„ë¼ì¸ êµ¬ë§¤ ë¹„ì¤‘
age_channel_counts = merged.groupby(['age_group', 'sales_channel_id']).size().unstack(fill_value=0)
age_channel_ratio = age_channel_counts.div(age_channel_counts.sum(axis=1), axis=0) * 100

print("\nì—°ë ¹ëŒ€ë³„ ì˜¨ë¼ì¸/ì˜¤í”„ë¼ì¸ êµ¬ë§¤ ë¹„ì¤‘ (%)")
print(age_channel_ratio)

# age_channel_ratio ì¬ì •ë¦¬ (ì¸ë±ìŠ¤ ì´ˆê¸°í™”)
plot_df = age_channel_counts.reset_index()

# age_channel_counts ì¬ì •ë¦¬ (ì¸ë±ìŠ¤ ì´ˆê¸°í™”)
plot_df = age_channel_counts.reset_index()

# ì»¬ëŸ¼ëª… ë§¤í•‘ (1 â†’ ì˜¤í”„ë¼ì¸, 2 â†’ ì˜¨ë¼ì¸)
plot_df = plot_df.rename(columns={1: 'ì˜¤í”„ë¼ì¸', 2: 'ì˜¨ë¼ì¸'})

# Meltë¡œ ê¸´ í˜•íƒœë¡œ ë³€í™˜ (seaborn barplotì— ì í•©í•œ í˜•íƒœë¡œ ë³€í™˜)
plot_df_melt = pd.melt(plot_df, id_vars='age_group', value_vars=['ì˜¤í”„ë¼ì¸', 'ì˜¨ë¼ì¸'],
                       var_name='êµ¬ë§¤ì±„ë„', value_name='ë§¤ì¶œ')

# ì‹œê°í™”
plt.figure(figsize=(10,6))
ax = sns.barplot(x='age_group', y='ë§¤ì¶œ', hue='êµ¬ë§¤ì±„ë„', data=plot_df_melt)

# ë§‰ëŒ€ ìœ„ì— ë§¤ì¶œ ìˆ«ì í‘œì‹œ
for p in ax.patches:
    height = p.get_height()
    if height > 0:   # ë§‰ëŒ€ì˜ ë†’ì´ (ë§¤ì¶œ ê°’)
        ax.text(p.get_x() + p.get_width() / 2, height + 1000,  # ìˆ«ìê°€ ë§‰ëŒ€ ìœ„ë¡œ ì¡°ê¸ˆ ì˜¬ë¼ê°€ê²Œ ì¡°ì •
            f'{height:,.0f}', ha='center', va='bottom')  # ë§¤ì¶œ ê°’ í‘œì‹œ (ì‰¼í‘œë¡œ êµ¬ë¶„)

plt.title('ì—°ë ¹ëŒ€ë³„ ì˜¨ë¼ì¸/ì˜¤í”„ë¼ì¸ ë§¤ì¶œ ë¹„êµ')
plt.ylabel('ë§¤ì¶œ')
plt.xlabel('ì—°ë ¹ëŒ€')
plt.legend(title='êµ¬ë§¤ì±„ë„')

plt.show()

# ë¹„ì¤‘ ì¬ì •ë¦¬ (ì¸ë±ìŠ¤ ì´ˆê¸°í™”)
plot_df = age_channel_ratio.reset_index()

# ì»¬ëŸ¼ëª… ë§¤í•‘ (1 â†’ ì˜¤í”„ë¼ì¸, 2 â†’ ì˜¨ë¼ì¸)
plot_df = plot_df.rename(columns={1: 'ì˜¤í”„ë¼ì¸', 2: 'ì˜¨ë¼ì¸'})

# Meltë¡œ ê¸´ í˜•íƒœë¡œ ë³€í™˜ (seaborn barplotì— ì í•©í•œ í˜•íƒœë¡œ ë³€í™˜)
plot_df_melt = pd.melt(plot_df, id_vars='age_group', value_vars=['ì˜¤í”„ë¼ì¸', 'ì˜¨ë¼ì¸'],
                       var_name='êµ¬ë§¤ì±„ë„', value_name='ë¹„ì¤‘')

# ì‹œê°í™”
plt.figure(figsize=(10,6))
ax = sns.barplot(x='age_group', y='ë¹„ì¤‘', hue='êµ¬ë§¤ì±„ë„', data=plot_df_melt)

# ë§‰ëŒ€ ìœ„ì— ë¹„ì¤‘ ìˆ«ì í‘œì‹œ
for p in ax.patches:
    height = p.get_height()  # ë§‰ëŒ€ì˜ ë†’ì´ (ë¹„ì¤‘ ê°’)
    if height > 0:  # 0ì¼ ë•ŒëŠ” í‘œì‹œí•˜ì§€ ì•ŠìŒ
       ax.text(p.get_x() + p.get_width() / 2, height + 1,  # ìˆ«ìê°€ ë§‰ëŒ€ ìœ„ë¡œ ì¡°ê¸ˆ ì˜¬ë¼ê°€ê²Œ ì¡°ì •
            f'{height:.1f}%', ha='center', va='bottom')  # ë¹„ì¤‘ ê°’ í‘œì‹œ (ì†Œìˆ˜ì  1ìë¦¬)

plt.title('ì—°ë ¹ëŒ€ë³„ ì˜¨ë¼ì¸/ì˜¤í”„ë¼ì¸ êµ¬ë§¤ ë¹„ìœ¨(%)')
plt.ylabel('ë¹„ìœ¨ (%)')
plt.xlabel('ì—°ë ¹ëŒ€')
plt.legend(title='êµ¬ë§¤ì±„ë„')
plt.ylim(0, 100)  # ë¹„ì¤‘ì„ í¼ì„¼íŠ¸ë¡œ í‘œì‹œí•˜ê¸° ìœ„í•´ yì¶• ë²”ìœ„ ì„¤ì •
plt.show()

"""# **ê°€ì„¤ : ì˜¨ë¼ì¸/ì˜¤í”„ë¼ì¸ ê° ì±„ë„ì—ì„œ êµ¬ë§¤ ì§‘ì¤‘ë˜ëŠ” ì œí’ˆì´ ìˆì„ ê²ƒì´ë‹¤.**"""

# ê²°ì¸¡ì¹˜ ì œê±°ëŠ” ì•ˆí•˜ëŠ” ê±¸ë¡œ

# ê±°ë˜ ë°ì´í„°ì— ìƒí’ˆ ì •ë³´ ë³‘í•©
merged_df = pd.merge(transactions, articles, on = 'article_id', how = 'inner')

# ì±„ë„ë³„ ì¹´í…Œê³ ë¦¬ êµ¬ë§¤ ë¹„ìœ¨ ê³„ì‚°

# step 1: count ë¨¼ì €
category_count = (
    merged_df.groupby(['sales_channel_id', 'product_type_name'])
    .size()
    .reset_index(name='count')
)

category_count

# step 2: ë¹„ìœ¨(percentage) ê³„ì‚°
category_count['percentage'] = (
    category_count
    .groupby('sales_channel_id')['count']
    .transform(lambda x: 100 * x / x.sum())
)

category_count

# ì˜¨ë¼ì¸ (sales_channel_id = 2) ìƒìœ„ 10ê°œ
top10_online = (
    category_count[category_count['sales_channel_id'] == 2]
    .sort_values(by='count', ascending=False)
    .head(10)
    .reset_index()
)
top10_online.index=top10_online.index+1
top10_online

# ì˜¤í”„ë¼ì¸ (sales_channel_id = 1) ìƒìœ„ 10ê°œ
top10_offline = (
    category_count[category_count['sales_channel_id'] == 1]
    .sort_values(by='count', ascending=False)
    .head(10)
    .reset_index()
)
top10_offline.index=top10_offline.index+1

top10_offline

# ê³µí†µ ì¹´í…Œê³ ë¦¬ ê¸°ì¤€ìœ¼ë¡œ ë¹„êµ
top_categories = pd.concat([top10_online, top10_offline])
common_top = top_categories['product_type_name'].value_counts().index[:10]

online_data = top10_online[top10_online['product_type_name'].isin(common_top)][['product_type_name', 'count']]
offline_data = top10_offline[top10_offline['product_type_name'].isin(common_top)][['product_type_name', 'count']]

merged_counts = pd.merge(offline_data, online_data, on='product_type_name', how='outer', suffixes=('_offline', '_online')).fillna(0)
merged_counts = merged_counts.sort_values(by='product_type_name')

# ê·¸ë˜í”„
x = range(len(merged_counts))
plt.figure(figsize=(12, 6))
plt.bar([i - 0.2 for i in x], merged_counts['count_offline'], width=0.4, label='ì˜¤í”„ë¼ì¸')
plt.bar([i + 0.2 for i in x], merged_counts['count_online'], width=0.4, label='ì˜¨ë¼ì¸')
plt.xticks(x, merged_counts['product_type_name'], rotation=45, ha='right')
plt.ylabel('êµ¬ë§¤ ê±´ìˆ˜')
plt.title('ì¹´í…Œê³ ë¦¬ë³„ ì˜¨ë¼ì¸ vs ì˜¤í”„ë¼ì¸ êµ¬ë§¤ ê±´ìˆ˜ ë¹„êµ')
plt.legend()
plt.tight_layout()
plt.show()

import pandas as pd
import matplotlib.pyplot as plt
import matplotlib.cm as cm
import numpy as np

# ê³µí†µ ì¹´í…Œê³ ë¦¬
common_names = set(top10_online['product_type_name']) & set(top10_offline['product_type_name'])

# ìƒ‰ìƒ ë§µí•‘
all_names = pd.concat([top10_offline, top10_online])['product_type_name'].unique()
cmap = cm.get_cmap('tab20', len(all_names))

color_map = {}
used_index = 0
for name in all_names:
    if name in common_names:
        if name not in color_map:
            color_map[name] = cmap(used_index)
            used_index += 1
    else:
        color_map[name] = cmap(used_index)
        used_index += 1

# âœ… count ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬
top10_offline_sorted = top10_offline.sort_values(by='count', ascending=True)  # ì˜¤ë¦„ì°¨ìˆœìœ¼ë¡œ ë†“ê³  invert_yaxis()
top10_online_sorted = top10_online.sort_values(by='count', ascending=True)

# ê·¸ë˜í”„
fig, axes = plt.subplots(1, 2, figsize=(14, 6), sharey=True)

# ì˜¤í”„ë¼ì¸
axes[0].barh(top10_offline_sorted['product_type_name'], top10_offline_sorted['count'],
             color=[color_map[name] for name in top10_offline_sorted['product_type_name']])
axes[0].set_title('ì˜¤í”„ë¼ì¸ Top 10')
axes[0].invert_yaxis()  # âœ… ê°€ì¥ ë§ì€ ê²Œ ìœ„ë¡œ ì˜¤ë„ë¡ ì„¤ì •

# ì˜¨ë¼ì¸
axes[1].barh(top10_online_sorted['product_type_name'], top10_online_sorted['count'],
             color=[color_map[name] for name in top10_online_sorted['product_type_name']])
axes[1].set_title('ì˜¨ë¼ì¸ Top 10')
axes[1].invert_yaxis()  # âœ… ì—­ì‹œ ê°€ì¥ ë§ì€ ê²Œ ìœ„

plt.suptitle('Top 10 ì¹´í…Œê³ ë¦¬ ë¹„êµ (ê²¹ì¹˜ëŠ” í•­ëª©ì€ ê°™ì€ ìƒ‰)', fontsize=14)
plt.tight_layout()
plt.show()

"""# **ê°€ì„¤ : í‰ì¼ë³´ë‹¤ ì£¼ë§ì— ë§¤ì¶œì´ ë†’ì„ ê²ƒì´ë‹¤**

## **ìš”ì¼ë³„ ë§¤ì¶œ ì§‘ê³„í™•ì¸í•´ë³´ê¸°**
"""

import pandas as pd

# 1. ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
# 2. Null ê°’ ì œê±°
# 3. ë‚ ì§œ ì»¬ëŸ¼ì„ datetime í˜•ì‹ìœ¼ë¡œ ë³€í™˜
transactions['t_dat'] = pd.to_datetime(transactions['t_dat'])

# 4. ìš”ì¼ ì •ë³´ ì¶”ì¶œ
# - weekday_num: ìˆ«ì ìš”ì¼ (0=ì›”, ..., 6=ì¼)
# - weekday_name: ë¬¸ì ìš”ì¼ (Monday, ..., Sunday)
transactions['weekday_num'] = transactions['t_dat'].dt.dayofweek
transactions['weekday_name'] = transactions['t_dat'].dt.day_name()

# 5. ìš”ì¼ë³„ ë§¤ì¶œ ì§‘ê³„ (ì´ ë§¤ì¶œ í•©ê³„)
sales_by_weekday = (
    transactions.groupby('weekday_name')['price']
    .sum()
    .reindex(['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'])  # ìš”ì¼ ìˆœì„œëŒ€ë¡œ ì •ë ¬
    .reset_index()
)

# 6. ê²°ê³¼ ì¶œë ¥
print("ğŸ“Š ìš”ì¼ë³„ ì´ ë§¤ì¶œ")
print(sales_by_weekday)

"""## **ì±„ë„ë³„-ìš”ì¼ë³„ ë§¤ì¶œ í™•ì¸í•´ë³´ê¸°**"""

# ë‚ ì§œë¥¼ datetimeìœ¼ë¡œ ë³€í™˜
transactions["t_dat"] = pd.to_datetime(transactions["t_dat"])

# ìš”ì¼ ì»¬ëŸ¼ ì¶”ê°€ (0=ì›” ~ 6=ì¼ â†’ ìš”ì¼ ì´ë¦„ìœ¼ë¡œ ë§¤í•‘)
weekday_names = ["ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† ", "ì¼"]
transactions["weekday_name"] = transactions["t_dat"].dt.dayofweek.map(lambda x: weekday_names[x])

# ìš”ì¼ë³„ + ì±„ë„ë³„ ë§¤ì¶œ ì§‘ê³„
sales_by_weekday_named = (
    transactions
    .groupby(["weekday_name", "sales_channel_id"])["price"]
    .sum()
    .reset_index()
    .pivot(index="weekday_name", columns="sales_channel_id", values="price")
    .rename(columns={1: "ì˜¤í”„ë¼ì¸", 2: "ì˜¨ë¼ì¸"})
    .reindex(weekday_names)  # ìš”ì¼ ìˆœì„œ ìœ ì§€
)

# ì‹œê°í™”
ax = sales_by_weekday_named.plot(kind="bar", figsize=(10, 8))
plt.title("ìš”ì¼ë³„ ì±„ë„ë³„ ë§¤ì¶œ ë¹„êµ")
plt.xlabel("ìš”ì¼")
plt.ylabel("ì´ ë§¤ì¶œ")
plt.xticks(rotation=0)
plt.legend(title="ì±„ë„")
plt.tight_layout()

# ë§‰ëŒ€ ìœ„ì— ìˆ«ì í‘œì‹œ
for container in ax.containers:
    for bar in container:
        height = bar.get_height()
        if height > 0:  # 0 ì´ìƒì¼ ë•Œë§Œ í‘œì‹œ
            ax.text(
                bar.get_x() + bar.get_width() / 2,
                height + (height * 0.01),  # ì•½ê°„ ìœ„ë¡œ
                f'{height:,.0f}',  # ì²œ ë‹¨ìœ„ ì½¤ë§ˆ, ì •ìˆ˜ë¡œ í‘œì‹œ
                ha='center', va='bottom', fontsize=9
            )

plt.show()

# ìš”ì¼ë³„ + ì±„ë„ë³„ êµ¬ë§¤ ê±´ìˆ˜ ì§‘ê³„
purchase_count_by_weekday = (
    transactions
    .groupby(["weekday_name", "sales_channel_id"])["article_id"]
    .count()
    .reset_index()
    .pivot(index="weekday_name", columns="sales_channel_id", values="article_id")
    .rename(columns={1: "ì˜¤í”„ë¼ì¸", 2: "ì˜¨ë¼ì¸"})
    .reindex(weekday_names)
)

# ì‹œê°í™”
ax = purchase_count_by_weekday.plot(kind="bar", figsize=(10, 8))
plt.title("ìš”ì¼ë³„ ì±„ë„ë³„ êµ¬ë§¤ ê±´ìˆ˜ ë¹„êµ")
plt.xlabel("ìš”ì¼")
plt.ylabel("êµ¬ë§¤ ê±´ ìˆ˜")
plt.xticks(rotation=0)
plt.legend(title="ì±„ë„")
plt.tight_layout()

# ë§‰ëŒ€ ìœ„ì— ìˆ«ì í‘œì‹œ
for container in ax.containers:
    for bar in container:
        height = bar.get_height()
        if height > 0:  # 0 ì´ìƒë§Œ í‘œì‹œ
            ax.text(
                bar.get_x() + bar.get_width() / 2,
                height + (height * 0.01),  # ë†’ì´ë³´ë‹¤ ì•½ê°„ ìœ„
                f'{int(height):,}',        # ì •ìˆ˜ë¡œ ì²œ ë‹¨ìœ„ ì½¤ë§ˆ í‘œì‹œ
                ha='center', va='bottom', fontsize=9
            )

plt.show()